!function(t,e){function i(t,e){for(var i=t.length,s=0;i>s;){if(t[s]===e)return s;s++}return-1}function s(t){return t=t||[],t[t.length-1]}function n(t,i,s){var n,r=t[0];if(i=i===e?0:i,s=s===e?t.val().length:s,r.setSelectionRange){if(r.setSelectionRange(i,s),/chrom(e|ium)/.test(navigator.userAgent.toLowerCase())){var a=jQuery.Event("keydown",{which:37});t.triggerHandler(a)}}else r.createTextRange&&(n=r.createTextRange(),n.collapse(!0),n.moveEnd("character",s),n.moveStart("character",i),n.select())}var r=function(e,i){this.element=t(e),this.init(i)};r.defaults={fields:{id:"id",text:"text",left:"left",right:"right",level:"level",leaf:"leaf",path:"path",expand:"expand"},itemSize:32,dragSize:16,stepSize:25,buffSize:20,delay:10,buffer:10,markup:'<div class="bt-node bt-hbox {{if _last}}bt-last{{/if}}" data-id="{{:id}}" data-level="{{:level}}" data-leaf="{{:leaf}}">{{for _elbows}}<div class="bt-node-elbow {{:type}}">{{:icon}}</div>{{/for}}<div class="bt-node-body bt-flex bt-hbox"><div class="bt-drag"></div><div class="bt-text bt-flex bt-hbox">{{:text}}</div><div class="bt-plugin"></div><div class="bt-trash"></div></div></div>',debug:!0},r.prototype={init:function(e){this.options=t.extend(!0,{},r.defaults,e||{}),this._data=[],this._indexes={},this._visible=[],this._message="",this._uuid=[],this._initComponent(),this._initEvents(),this._fireEvent("init")},_guid:function(){if(!this._uuid.length)for(var t=0;256>t;t++)this._uuid[t]=(16>t?"0":"")+t.toString(16);var e=this._uuid,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,n=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return e[255&i]+e[i>>8&255]+e[i>>16&255]+e[i>>24&255]+e[255&s]+e[s>>8&255]+e[s>>16&15|64]+e[s>>24&255]+e[63&n|128]+e[n>>8&255]+e[n>>16&255]+e[n>>24&255]+e[255&r]+e[r>>8&255]+e[r>>16&255]+e[r>>24&255]},_initComponent:function(){{var e=this.options;e.fields}this.element.addClass("bigtree").attr("tabindex",1),this.editor=t('<div class="bt-editor"><input type="text"></div>'),this.edtext=this.editor.children("input"),this.grid=t('<div class="bt-grid">').appendTo(this.element),t.templates({btnode:{markup:e.markup}}),this.element.sortable({items:".bt-node",handle:".bt-drag",placeholder:"bt-node-sortable ui-sortable-placeholder"})},_initEvents:function(){var e=this.options;this._scrollTop=this.element.scrollTop(),this._scrollDir="",this._scrollDif=0,this.element.off("scroll.bt").on("scroll.bt",t.debounce(e.delay,t.proxy(this._onScroll,this))),this.element.off("click.bt.expander").on("click.bt.expander",".elbow-expander",t.proxy(this._onExpanderClick,this)),this.element.off("keydown.bt").on("keydown.bt",t.proxy(this._onNavigate,this)),this.element.off("sortstart.bt").on("sortstart.bt",t.proxy(this._onBeforeDrag,this)),this.element.off("sortstop.bt").on("sortstop.bt",t.proxy(this._onAfterDrag,this)),this.element.off("click.bt.select").on("click.bt.select",t.proxy(function(){this.deselectAll()},this)),this.element.off("click.bt.startedit").on("click.bt.startedit",".bt-text",t.proxy(function(e){e.stopPropagation();var i=t(e.currentTarget).closest(".bt-node");this._startEdit(i)},this)),this.edtext.off("click.bt").on("click.bt",function(t){t.preventDefault(),t.stopPropagation()}),this.edtext.off("keypress.bt").on("keypress.bt",t.proxy(function(t){13==t.keyCode&&(t.preventDefault(),this._stopEdit(!1))},this))},_reindex:function(t,i){var s,n=this.options.fields;for(t=t===e?0:t,i=i===e?this._data.length:i,s=t;i>s;s++)this._indexes[this._data[s][n.id]]=s},_rebuild:function(t,i){var n,r=this.options.fields,a=null;for(t=t===e?0:t,i=i===e?this._data.length:i,t>0&&this._data[t]&&(a=this._data[t]._root||null),n=t;i>n;n++){{var h=this._data[n];h[r.id]}if(h._elbows=[],h._level=0,0===+h[r.level])a&&(a._last=!1),h._root=null,h._parent=null,h._last=!0,h._hidden=!1,a=h;else{var l,o,d=h[r.path].split("/");d.pop(),d=d.pop(),l=this._data[this._indexes[d]],l._child=l._child||[],o=this._data[this._indexes[s(l._child)]],o&&(o._last=!1),h._root=a,h._parent=l,h._last=!0,h._hidden=0===+l[r.expand]||l._hidden,l._child.push(h[r.id])}}},_renderRange:function(e,i,s){var n=e.slice(i,s),r=this.options.fields,a=this.movedNode();this._fireEvent("beforenodesrender"),this.editor.detach(),this.removableNodes().remove(),a.length&&(n=t.grep(n,function(t){return t[r.id]!=a.attr("data-id")})),this._visible=n;for(var h=0,l=n.length;l>h;h++){for(var o,d,c,e=n[h],f=e._parent,_=+e[r.level],p=0===+e[r.leaf],u=1===+e[r.expand],v=[],g=[];f;)v[f[r.level]]=f._last?0:1,f=f._parent;for(c=0;_>=c;c++)c===_?(o="elbow-end",d=p?'<span class="elbow-expander '+(u?"elbow-minus":"elbow-plus")+'"></span>':""):(o=1===v[c]?"elbow-line":"",d=""),g.push({type:o,icon:d});e._elbows=g}this.grid.append(t.templates.btnode(n)),this.element.focus(),a.length?this.element.sortable("refresh"):this._decorate();var b=this.visible(),x=this.visibleNodes();this._fireEvent("nodesrender",x,b)},_decorate:function(){if(this._selected){var t=this.grid.find(".bt-node[data-id="+this._selected+"]");t.length&&this.select(t)}},_isvalid:function(t,e,i){var s=this.options.fields;if(this.isphantom(i))return this._error(e+"(): destination doesn't exists!"),!1;if(i[s.id]==t[s.id])return this._error(e+"(): can't move to itself!"),!1;if(this.isdescendant(t,i))return this._error(e+"(): can't move to descendant!"),!1;switch(e){case"before":if(this.index(i)-this.descendants(t).length-1==this.index(t)&&t[s.level]==i[s.level]&&!this.isphantom(t))return this._error("before(): nothing to move!"),!1;break;case"after":if(this.index(i)+this.descendants(i).length+1==this.index(t)&&t[s.level]==i[s.level]&&!this.isphantom(t))return this._error("after(): nothing to move!"),!1;break;case"append":var n=i._child||[];if(n[n.length-1]==t[s.id]&&!this.isphantom(t))return this._error("append(): nothing to move!"),!1;if(!this.isexpanded(i))return this._error("append(): can't append to collapsed data!"),!1}return!0},_detach:function(t,e){var s=this.options.fields,n=this.index(t),r=e.length;if(n>-1){t._origin=null;var a=t._parent||null,h=RegExp(".*(?="+(a?"/":"")+t[s.id]+"/?)"),l=RegExp("^/");if(level=+t[s.level],a){a._child=a._child||[];var o=i(a._child,t[s.id]);o>-1&&(a._child.splice(o,1),a._child.length||(a[s.leaf]="1")),t._origin=a}else{var d=this.prev(t);d&&(t._origin=d)}if(this._data.splice(n,1),delete this._indexes[t[s.id]],t._parent=null,t._root=null,t[s.level]=0,t[s.path]=t[s.path].replace(h,"").replace(l,""),r){this._data.splice(n,r);for(var c=0;r>c;c++)e[c]._root=null,e[c][s.path]=e[c][s.path].replace(h,"").replace(l,""),e[c][s.level]=+e[c][s.level]-level,delete this._indexes[e[c][s.id]]}h=null,l=null,this._reindex(n)}},_attach:function(t,e,i,s){var n,r=this.options.fields,a=e.length,h=-1,l="",o=0,d=0,c=null,f=null,_=0;switch(i){case"after":h=this.index(s),d=+s[r.level],c=s._parent,f=s._root,_=+s[r.left]+this.size(s),c?(l=c[r.path]+"/",o=this.index(c)):o=h,h+=this.descendants(s).length+1;break;case"before":h=this.index(s),d=+s[r.level],c=s._parent,f=s._root,_=+s[r.left],c&&(l=c[r.path]+"/",o=this.index(c));break;case"append":l=s[r.path]+"/",h=this.index(s),d=+s[r.level]+1,f=s._root,_=+s[r.right],o=h,h+=this.descendants(s).length+1,"1"==s[r.leaf]&&(s[r.leaf]="0")}if(h>-1){if(this._data.splice(h,0,t),t._root=f,t[r.level]=d,t[r.path]=l+t[r.path],a)for(Array.prototype.splice.apply(this._data,[h+1,0].concat(e)),n=0;a>n;n++)e[n][r.level]=+e[n][r.level]+d,e[n][r.path]=l+e[n][r.path];this._reindex(h);var p,u;(p=t._origin)&&(u=this.index(p),o>u&&(o=u),delete t._origin);var v,g,b,x=_,m=+t[r.left],k=+t[r.right],y=this._data.length;for(n=0;y>n;n++)v=this._data[n],g=+v[r.left],b=+v[r.right],(x>k||m>x)&&(x>k?(g+=g>k&&x>g?m-k-1:g>=m&&k>g?x-k-1:0,b+=b>k&&x>b?m-k-1:b>m&&k>=b?x-k-1:0):(g+=g>=x&&m>g?k-m+1:g>=m&&k>g?x-m:0,b+=b>=x&&m>b?k-m+1:b>m&&k>=b?x-m:0),v[r.left]=g,v[r.right]=b),o>n||v._parent&&(v._parent._child=[]);this._rebuild(o)}},_insert:function(t,e,s){var n,r,a,h,l,o=this.options.fields;switch(e){case"append":t._last=!0,t._root=s._root,t._parent=s,s[o.leaf]=0,t[o.path]=s[o.path]+"/"+t[o.id],t[o.level]=+s[o.level]+1,s._child=s._child||[],n=s._child.length?this.index(this.get(s._child[s._child.length-1]))+1:this.index(s)+1,s._child.push(t),h=+s[o.right];break;case"before":t[o.left]=s[o.left],t[o.right]=s[o.right],t[o.level]=s[o.level],t._last=!1,t._root=s._root,t._parent=s._parent,n=this.index(s),h=this.left(s),t._parent?(r=t._parent._child||[],a=i(r,s[o.id]),a=-1>a?0:a,r.splice(a,0,t),t[o.path]=t._parent[o.path]+"/"+t[o.id]):t[o.path]=t[o.id];break;case"after":}for(var d=0,c=this._data.length;c>d;d++)l=this._data[d],l[o.left]<h||(l[o.left]=+l[o.left]+2),l[o.right]<h||(l[o.right]=+l[o.right]+2);t[o.left]=h,t[o.right]=h+1,this._data.splice(n,0,t),this._reindex(),this._rebuild()},_startEdit:function(e){var i=this._data[this._indexes[e.attr("data-id")]],s=this.options.fields,r=e.find(".bt-text"),a=i[s.text];i._orig&&i._orig.text&&(a=i._orig.text),this._stopEdit(!0),this.select(e),this.editor.appendTo(r),this.edtext.val(a).focus();var h=t.debounce(1,function(){n(this.edtext,a.length)});h.call(this)},_stopEdit:function(t){var i=this.options.fields,s=this.editor.closest(".bt-node");if(s.length){var n=this._data[this._indexes[s.attr("data-id")]],r=this.edtext.val(),a=n[i.text],h=r;n._orig&&n._orig.text&&(a=n._orig.text,h=n._orig.disp),n[i.text]=h,t=t===e?!0:t,t&&(this.deselect(s),this.editor.detach(),s.find(".bt-text").html(h)),r!=a&&this._fireEvent("edit",n,r)}else this._selected=null,this.grid.find(".bt-selected").removeClass("bt-selected")},_fireEvent:function(){var e=t.makeArray(arguments),i=e.shift()+".bt";this.element.trigger(i,e)},hasScroll:function(){return this.element[0].scrollHeight>this.element.height()},load:function(t,i){var s,n=(this.options.fields,this._data.length);this._data.push.apply(this._data,t||[]),s=this._data.length,this._reindex(n,s),this._rebuild(n,s),i=i===e?!1:i,i&&this.render()},render:function(){var e=this.options.buffer*this.options.itemSize,i=this.grid.scrollTop()-this.grid.position().top-e,s=i+this.element.height()+2*e,n=t.grep(this._data,function(t){return!t._hidden});i=0>i?0:i;var r=Math.floor(i/this.options.itemSize),a=Math.ceil(s/this.options.itemSize),h=this.options.itemSize*r,l=this.options.itemSize*n.slice(a).length+3*this.options.itemSize;this.grid.css({paddingTop:h,paddingBottom:l}),this._renderRange(n,r,a)},scroll:function(e){var s=this.options,n=t.grep(this._data,function(t){return!t._hidden}),r=i(n,e)*s.itemSize,a=this.element;a.animate({scrollTop:r},r)},visible:function(){return this._visible},create:function(t){if(!t)return this._error("create(): spec doesn't meet requirement!"),!1;var i,s,n=this.options.fields,r=this._guid();for(i in n)if(s=n[i],t[s]===e)switch(i){case"id":t[s]=r;break;case"leaf":case"expand":t[s]=1;break;default:t[s]=""}t._hidden=!1;var a=this.selection(),h=this.first(),l=!0;return a?l=this.append(a,t):h?(this._selected=r,l=this.before(h,t)):(t[n.left]=1,t[n.right]=2,t._root=null,t._parent=null,t._last=!0,this._data.unshift(t),this._reindex(),this._rebuild(),this.render(),render=!0,l=!0),this._debug(),l},remove:function(t){t=t||{}},update:function(t,e){t=t||{},e=e||{}},append:function(t,e){if(this._isvalid(e,"append",t)){var i,s=this.nodeof(t);return this.isphantom(e)?this._insert(e,"append",t):(i=this.descendants(e),this._detach(e,i),this._attach(e,i,"append",t)),s.length&&this.render(),!0}return!1},before:function(t,e){if(this._isvalid(e,"before",t)){var i,s=this.nodeof(t);return this.isphantom(e)?this._insert(e,"before",t):(i=this.descendants(e),this._detach(e,i),this._attach(e,i,"before",t)),s.length&&this.render(),!0}return!1},after:function(t,e){if(this._isvalid(e,"after",t)){var i=this.descendants(e),s=this.nodeof(t);return this._detach(e,i),this._attach(e,i,"after",t),s.length&&this.render(),!0}return!1},get:function(t){var e=this._indexes[t];return this._data[e]||null},data:function(t){return t!==e?this._data[t]:this._data},index:function(t){if(t){var i=t[this.options.fields.id],s=this._indexes[i];return s===e?-1:s}return-1},size:function(t){return this.right(t)-this.left(t)+1},level:function(t){return+t[this.options.fields.level]},left:function(t){return+t[this.options.fields.left]},right:function(t){return+t[this.options.fields.right]},isphantom:function(t){return-1===this.index(t)},isleaf:function(t){return this.right(t)-this.left(t)===1},isparent:function(t){return!this.isleaf(t)},isancestor:function(t,e){return this.left(t)>this.left(e)&&this.right(t)<this.right(e)},isdescendant:function(t,e){return this.left(e)>this.left(t)&&this.right(e)<this.right(t)},isexpanded:function(t){return 1===+t[this.options.fields.expand]},iscollapsed:function(t){return!this.isexpanded(t)},isvisible:function(t){var e=this.visible();return i(e,t)>-1},first:function(){return this._data[0]},last:function(){return this._data[this._data.length-1]},parent:function(t){return t._parent},prev:function(t){var e,s=this.options.fields,n=t._parent,r=null;if(n){var a=n._child||[];e=this._indexes[a[i(a,t[s.id])-1]],r=this.data(e)}else{var h,l,o;for(e=this.index(t),o=this.level(t),h=this._data[--e];h&&(l=+h[s.level])>=o;){if(l===o){r=h;break}h=this._data[--e]}}return r||null},next:function(t){var e,s=this.options.fields,n=t._parent,r=null;if(n){var a=n._child||[];e=this._indexes[a[i(a,t[s.id])+1]],r=this.data(e)}else{var h,l,o;for(e=this.index(t),l=this.level(t),h=this._data[++e];h&&(o=+h[s.level])>=l;){if(o===l){r=h;break}h=this._data[++e]}}return r},descendants:function(t){for(var e=this.options.fields,i=this._indexes[t[e.id]],s=this._data[++i],n=[],r=+t[e.right];s&&+s[e.right]<r;)n.push(s),s=this._data[++i];return n},children:function(t){for(var e=t._child||[],i=e.length,s=[],n=0;i>n;n++){var r=this._indexes[e[n]],a=this._data[r];a&&s.push(a)}return s},createNode:function(e){return t(t.templates.btnode(e))},nodeof:function(t){return this.grid.children(".bt-node[data-id="+t[this.options.fields.id]+"]")},movedNode:function(){return this.grid.children(".ui-sortable-helper")},visibleNodes:function(){return this.grid.children(".bt-node:not(.ui-sortable-placeholder)")},removableNodes:function(){return this.grid.children(".bt-node:not(.ui-sortable-helper,.ui-sortable-placeholder)")},selectedNode:function(){var e=t({});return this._selected&&(e=this.grid.children(".bt-node[data-id="+this._selected+"]")),e.length?e:null},dataof:function(t){var e=t.attr("data-id");return this._data[this._indexes[e]]},cascade:function(e,i,s){var n=this.descendants(e)||[];n.unshift(e),s=s||this,t.each(n,function(e,n){t.proxy(i,s,n)()})},expand:function(t){var i=this.options.fields,s=function(t){for(var n=this.children(t),r=n.length,a=0;r>a;a++)n[a]._hidden=!1,n[a]._child!==e&&"1"==n[a][i.expand]&&s.call(this,n[a])};t[i.expand]="1",s.call(this,t),this._fireEvent("expand",t),this.render()},collapse:function(t){var i=this.options.fields,s=function(t){for(var n=this.children(t),r=n.length,a=0;r>a;a++)n[a]._hidden=!0,n[a]._child!==e&&"1"==n[a][i.expand]&&s.call(this,n[a])};t[i.expand]="0",s.call(this,t),this._fireEvent("collapse",t),this.render()},toggle:function(t,i,s){var n=t.find(".elbow-expander");if(i=i===e?!0:i,n.length&&i){var r=n.hasClass("elbow-plus")?"elbow-minus":"elbow-plus";s!==e&&(r="expand"==s?"elbow-minus":"elbow-plus"),n.removeClass("elbow-plus elbow-minus").addClass(r)}},select:function(t){this._selected=t.attr("data-id"),t.addClass("bt-selected")},deselect:function(t){this._selected=null,t.removeClass("bt-selected")},deselectAll:function(){this._selected=null,this.grid.children(".bt-selected").removeClass("bt-selected")},selection:function(){var t=this.grid.children(".bt-selected");return t.length?this._data[this._indexes[this._selected]]:null},query:function(t){var e,i,s,n,r=this.options.fields,a=RegExp("("+t+")","igm"),h=this._data.length;for(n=0;h>n;n++)if(i=this._data[n],i._orig&&(i._hidden=i._orig.hidden,i[r.expand]=i._orig.expand,i[r.text]=i._orig.text,delete i._orig),t){e=i[r.text],i._orig={hidden:i._hidden,expand:i[r.expand],text:e};var l=a.exec(e);if(i._hidden=!0,l){s=i[r.text].replace(l[1],'<span class="bt-hightlight">'+l[1]+"</span>"),i._hidden=!1,i._orig.disp=s,i[r.text]=s;for(var o=i._parent;o;)o._hidden&&(o._hidden=!1),o[r.expand]="1",o=o._parent}}a=null,this.render()},swap:function(t,i,s){var n,r,a=this._data.length;if(!(t==i||0>t||t>a||0>i||i>a)){if(n=this._data[t],i>t)for(r=t;i>r;r++)this._data[r]=this._data[r+1];else for(r=t;r>i;r--)this._data[r]=this._data[r-1];this._data[i]=n,s=s===e?!0:s,s&&this._reindex()}},plugin:function(){return this},tickStart:function(t){this.markers=this.markers||{},t=t===e?"_":t,this.markers[t]=new Date},tickStop:function(t){if(this.markers=this.markers||{},t=t===e?"_":t,this.markers[t]!==e){var i=(new Date-this.markers[t])/1e3+"ms";console.log(t+": "+i)}},_onScroll:function(){var t=this.options,e=this.element.scrollTop(),i=e>this._scrollTop?"down":"up";this._scrollDif=this._scrollDir!=i?0:this._scrollTop+Math.abs(e-this._scrollTop),0!==this._scrollDif&&this._scrollDif<t.buffer*t.itemSize||(this.render(),this._scrollDif=0),this._scrollTop=e,this._scrollDir=i},_onExpanderClick:function(e){e.stopPropagation();var i=t(e.currentTarget).closest(".bt-node"),s=this.get(i.attr("data-id"));s&&(this.isexpanded(s)?this.collapse(s):this.expand(s))},_onNavigate:function(t){var e=t.keyCode||t.which;if(9==e||38==e||40==e){var i,s,n=this.grid.find(".bt-selected");if(t.preventDefault(),n.length)switch(e){case 9:var r=t.shiftKey?"prev":"next",a=n[r].call(n);a.length&&this._startEdit(a);break;case 38:s=n.prev(".bt-node"),s.length&&this._startEdit(s);break;case 40:i=n.next(".bt-node"),i.length&&this._startEdit(i)}}},_onBeforeDrag:function(t,e){var i=this.options.fields,s=e.item,n=this.dataof(s);if(this.deselectAll(),this.select(s),s.addClass("bt-moving"),n){var r,a=(1===+n[i.expand],this.descendants(n)),h=a.length;h&&(this.toggle(s,!0,"collapse"),r=a.map(function(t){return".bt-node[data-id="+t[i.id]+"]"}).join(","),this.grid.children(r).remove())}},_onAfterDrag:function(t,e){var i=this.options,s=(this._indexes,i.fields),n=this._data,r=e.item,a=e.position.left,h=this.dataof(r),l=r.prev(".bt-node"),o=r.next(".bt-node"),d=function(t,e,i){var r,a=[],h=i-1,l=n[e];for(h=0>h?0:h;l&&(r=+l[s.level],r===i&&a.push(l),r!==h);)l=n[--e];return a.length?["after",a[a.length-1],t]:["append",l,t]};r.removeClass("bt-moving");var c=+h[s.level],f=0,_=5,p=[];if(a-=i.buffSize,f=a+_<-i.dragSize?c-Math.round(Math.abs(a)/i.stepSize):a>i.dragSize?c+Math.round(a/i.stepSize):c,f=0>f?0:f,l.length){var u=this.dataof(l),v=this.level(u),g=this.index(u),b=u._child||[];p=f>v?b.length?this.isexpanded(u)?["before",this.get(b[0]),h]:["after",u,h]:["append",u,h]:f===v?["after",u,h]:d(h,g,f)}else if(o.length){var x=this.dataof(o);p=["before",x,h]}else this._error("move(): nothing to move!");if(p.length){var m=p.shift(),k=this[m].apply(this,p);k?this.isvisible(h)||this.scroll(h):this._debug()}else this._debug()},_error:function(t){this._message=t},_debug:function(t){this.options.debug&&(t=t===e?this._message:t,console.log(t))},destroy:function(i){this.edtext.off(".bt"),this.element.off(".bt"),this.element.sortable("destroy"),t.removeData(this.element[0],"bigtree"),this._data=null,this._indexes=null,this._selected=null,i!==e&&i===!0&&(this.editor.remove(),this.element.remove())}},t.fn.bigtree=function(e){var i,s,n=t.makeArray(arguments),a="string"!==t.type(n[0]);return i=this.each(function(){var i=t.data(this,"bigtree");if(i||t.data(this,"bigtree",i=new r(this,e)),!a){var h=n.shift();if(!t.isFunction(i[h]))throw Error(h+" is not function!");s=i[h].apply(i,n)}}),a?i:s}}(jQuery);